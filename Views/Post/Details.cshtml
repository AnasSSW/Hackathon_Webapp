@model Hackathon.Models.Post

@{
    ViewData["Title"] = @Model.Title;
    ViewData["DisableMainCss"] = true;
    var isAuthor = ViewBag.IsAuthor as bool? ?? false;
    var isParticipant = ViewBag.IsParticipant as bool? ?? false;
}

@section Styles {
    <link rel="stylesheet" href="~/css/post-style.css" asp-append-version="true" />
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-9">
            <div class="post-details-card">
                @if (!string.IsNullOrEmpty(Model.ImageUrl))
                {
                    <div class="post-image-header">
                        <img src="@Model.ImageUrl" alt="@Model.Title" class="img-fluid" onerror="this.onerror=null;this.src='https://via.placeholder.com/900x400?text=No+Image';">
                    </div>
                }

                <div class="post-body">
                    <div class="post-meta">
                        <div class="author-info">
                            <img src="https://ui-avatars.com/api/?name=@(Model.Author?.FirstName)+@(Model.Author?.LastName)&background=random&color=fff&rounded=true" alt="Avatar">
                            <div class="author-details">
                                <p class="author-name">โดย: @Model.Author?.FirstName @Model.Author?.LastName</p>
                                <p class="post-date">โพสต์เมื่อ: @Model.CreatedAt.ToString("dd MMMM yyyy")</p>
                            </div>
                        </div>

                        <!-- แสดงสถานะโพสต์ (เปิด/ปิดรับสมัคร) -->
                        <div class="post-status">
                            @if (Model.IsClosed)
                            {
                                <span class="badge bg-danger">ปิดรับสมัคร</span>
                            }
                            else
                            {
                                <span class="badge bg-success">เปิดรับสมัคร</span>
                            }
                        </div>
                    </div>

                    <h1 class="post-title">@Model.Title</h1>

                    <div class="post-content">
                        <p>@Html.Raw(Model.Content.Replace("\n", "<br/>"))</p>
                    </div>

                    <hr />

                    <div class="post-footer">
                        <div class="expertise-tags">
                            @foreach (var expertise in Model.RequiredExpertise.Split(','))
                            {
                                <span class="tag">@expertise.Trim()</span>
                            }
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            @if (isAuthor)
                            {
                                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary">แก้ไขโพสต์</a>
                            }
                            else if (isParticipant)
                            {
                                <span class="badge bg-secondary">คุณเข้าร่วมแล้ว</span>
                            }
                            else
                            {
                                <form asp-action="Join" asp-route-id="@Model.Id" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-primary">เข้าร่วม</button>
                                </form>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ส่วนจัดการผู้เข้าร่วม (แสดงเฉพาะเจ้าของโพสต์) -->
@if (isAuthor)
{
    <div class="container mt-4 mb-5">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h3 class="mb-0">ผู้เข้าร่วม (Participants) (@Model.Participants.Count)</h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th scope="col">ชื่อผู้ใช้</th>
                                <th scope="col">ID ผู้เข้าร่วม</th>
                                <th scope="col">สถานะ</th>
                                <th scope="col">ดำเนินการ</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var participant in Model.Participants)
                            {
                                <tr>
                                    <td>@participant.User.FirstName @participant.User.LastName</td>
                                    <td>@participant.Id</td>
                                    <td>
                                        @if (participant.IsApproved)
                                        {
                                            <span class="badge bg-success">อนุมัติแล้ว</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark">รออนุมัติ</span>
                                        }
                                    </td>
                                    <td>
                                        @if (!participant.IsApproved)
                                        {
                                            <form asp-action="ApproveParticipant" method="post" class="d-inline">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@participant.Id" />
                                                <button type="submit" class="btn btn-sm btn-success">อนุมัติ</button>
                                            </form>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
}
